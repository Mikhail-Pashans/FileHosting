@using FileHosting.Domain.Models
@using FileHosting.MVC.Helpers
@model FileHosting.MVC.ViewModels.FilesIndexViewModel
@{
    ViewBag.Title = "Files";
}
@section search {
    @Html.Partial("_SearchPartial")
}
@section categories {
    @Html.Partial("_CategoriesPartial")
}
@section tags {
    @Html.Partial("_TagsPartial")
}
<div class="panel panel-primary no-margin">
    <div class="panel-body">
        <h3 class="no-margin">@ViewBag.Title</h3>
        <hr />
        @if (Model.Files != null && Model.Files.Any())
        {
            <table class="table table-striped">
                <thead>
                    <tr>                        
                        <th>
                            @Html.ActionLink("#", "Index", new { searchType = Model.SearchType, searchParam = Model.SearchParam, sortOrder = Model.IdSortParm })
                        </th>
                        <th>
                            @Html.ActionLink("Name", "Index", new { searchType = Model.SearchType, searchParam = Model.SearchParam, sortOrder = Model.NameSortParm })
                        </th>
                        <th>
                            @Html.ActionLink("Category", "Index", new { searchType = Model.SearchType, searchParam = Model.SearchParam, sortOrder = Model.CategorySortParm })
                        </th>
                        <th class="th-numbers">
                            @Html.ActionLink("Size (KB)", "Index", new { searchType = Model.SearchType, searchParam = Model.SearchParam, sortOrder = Model.SizeSortParm })
                        </th>
                        <th class="th-numbers">
                            @Html.ActionLink("Upload date", "Index", new { searchType = Model.SearchType, searchParam = Model.SearchParam, sortOrder = Model.DateSortParm })
                        </th>
                        <th class="th-control"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (FileModel file in Model.Files)
                    {
                        <tr>
                            <td>@file.Id</td>
                            <td>@file.Name</td>
                            <td>@file.Category.Name</td>
                            <td>@file.Size</td>
                            <td>@file.UploadDate</td>
                            <td class="text-right">
                                <div class="btn-group-vertical">
                                    <a class="btn btn-info" href="@Url.Action("FileDetails", new { fileId = file.Id })" role="button">
                                        <span class="glyphicon glyphicon-info-sign"></span>&ensp;Details
                                    </a>
                                    <a class="btn btn-success btn-download @if (!Model.IsAuthenticated && !file.IsAllowedAnonymousAction) { <text> disabled </text> }" href="javascript:void(0)" role="button">
                                        <span class="glyphicon glyphicon-download"></span>&ensp;Download
                                    </a>
                                </div>
                                <form action="@Url.Action("DownloadFile")" method="POST">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="fileId" value="@file.Id" />                                    
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
            <div>
                Page @(Model.PageInfo.TotalPages < Model.PageInfo.PageNumber ? 0 : Model.PageInfo.PageNumber) of @Model.PageInfo.TotalPages
            </div>
            @Html.PageLinks(Model.PageInfo, x => Url.Action("Index", new { searchType = Model.SearchType, searchParam = Model.SearchParam, sortOrder = Model.SortOrder, page = x }))
        }
        else
        {
            <div class="alert alert-danger no-margin text-center" role="alert">
                <strong>There are no any uploaded files!</strong>
            </div>
        }
    </div>
</div>
@section scripts {
    <script type="text/javascript">
        (function ($) {
            var $downloadButton = $('.btn-download');

            $downloadButton.on('click', function (event) {
                event.preventDefault();
                var $button = $(this);
                var $form = $button.parent().parent().find('form');
                $form.submit();
            });
        })(jQuery);
    </script>
}